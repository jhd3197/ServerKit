id: prometheus
name: Prometheus
version: "2.48"
description: Open-source monitoring and alerting toolkit designed for reliability and scalability
icon: https://raw.githubusercontent.com/prometheus/prometheus/main/documentation/images/prometheus-logo.svg
website: https://prometheus.io
documentation: https://prometheus.io/docs/
categories:
  - monitoring
  - metrics
  - alerting

variables:
  - name: HTTP_PORT
    description: HTTP port
    type: port
    default: "9090"
    hidden: true
  - name: RETENTION_TIME
    description: Data retention period
    default: 15d

ports:
  - port: 9090
    protocol: tcp
    description: Web interface and API

volumes:
  - name: data
    path: /prometheus
    description: Prometheus data storage
  - name: config
    path: /etc/prometheus
    description: Configuration files

compose:
  services:
    prometheus:
      image: prom/prometheus:v${VERSION:-2.48.0}
      container_name: ${APP_NAME}
      restart: unless-stopped
      command:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.tsdb.path=/prometheus'
        - '--storage.tsdb.retention.time=${RETENTION_TIME}'
        - '--web.console.libraries=/etc/prometheus/console_libraries'
        - '--web.console.templates=/etc/prometheus/consoles'
        - '--web.enable-lifecycle'
      volumes:
        - prometheus_data:/prometheus
        - prometheus_config:/etc/prometheus
      ports:
        - "${HTTP_PORT}:9090"

  volumes:
    prometheus_data:
    prometheus_config:

post_install: |
  # Create default prometheus config
  cat > /var/serverkit/apps/${APP_NAME}/config/prometheus.yml << 'EOF'
  global:
    scrape_interval: 15s
    evaluation_interval: 15s

  scrape_configs:
    - job_name: 'prometheus'
      static_configs:
        - targets: ['localhost:9090']
  EOF
