<?xml version="1.0" encoding="UTF-8"?>
<!--
  ServerKit Agent - Windows MSI Installer
  Built with WiX Toolset v4

  Build instructions:
    1. Install WiX Toolset v4
    2. Run: wix build Product.wxs -o serverkit-agent.msi
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

  <!-- Product definition -->
  <Package
    Name="ServerKit Agent"
    Manufacturer="ServerKit"
    Version="!(bind.FileVersion.ServerKitAgentExe)"
    UpgradeCode="E8B7F3A2-4C5D-4E6F-8A9B-0C1D2E3F4A5B"
    Scope="perMachine">

    <SummaryInformation
      Description="ServerKit Agent - Remote server management agent"
      Keywords="ServerKit,Agent,Docker,Management"
      Manufacturer="ServerKit" />

    <!-- Upgrade handling -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      Schedule="afterInstallInitialize" />

    <!-- Media -->
    <MediaTemplate EmbedCab="yes" />

    <!-- License -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- UI -->
    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    </UI>

    <!-- Feature -->
    <Feature Id="ProductFeature" Title="ServerKit Agent" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ServiceComponent" />
      <ComponentRef Id="ConfigComponent" />
    </Feature>

    <!-- Custom Actions -->
    <CustomAction Id="StopService"
      Directory="INSTALLFOLDER"
      ExeCommand="[SystemFolder]net.exe stop ServerKitAgent"
      Execute="deferred"
      Impersonate="no"
      Return="ignore" />

    <CustomAction Id="StartService"
      Directory="INSTALLFOLDER"
      ExeCommand="[SystemFolder]net.exe start ServerKitAgent"
      Execute="deferred"
      Impersonate="no"
      Return="ignore" />

    <InstallExecuteSequence>
      <Custom Action="StopService" Before="InstallFiles" Condition="Installed AND NOT UPGRADINGPRODUCTCODE" />
    </InstallExecuteSequence>
  </Package>

  <!-- Directory Structure -->
  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="ServerKit Agent">
        <Directory Id="LogsFolder" Name="logs" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="ServerKitDataFolder" Name="ServerKit">
        <Directory Id="AgentDataFolder" Name="Agent" />
      </Directory>
    </StandardDirectory>
  </Fragment>

  <!-- Components -->
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        <File Id="ServerKitAgentExe"
          Source="serverkit-agent.exe"
          KeyPath="yes">
          <Shortcut Id="StartMenuShortcut"
            Directory="ProgramMenuFolder"
            Name="ServerKit Agent"
            Description="ServerKit Agent Management"
            WorkingDirectory="INSTALLFOLDER"
            Advertise="yes" />
        </File>
      </Component>
    </ComponentGroup>

    <!-- Windows Service -->
    <Component Id="ServiceComponent" Directory="INSTALLFOLDER" Guid="B2C3D4E5-F6A7-8901-BCDE-F23456789012">
      <File Id="ServiceExe" Source="serverkit-agent.exe" KeyPath="yes" />
      <ServiceInstall
        Id="ServiceInstall"
        Name="ServerKitAgent"
        DisplayName="ServerKit Agent"
        Description="ServerKit Agent - Remote server management service"
        Type="ownProcess"
        Start="auto"
        ErrorControl="normal"
        Arguments="start">
        <ServiceDependency Id="Tcpip" />
      </ServiceInstall>
      <ServiceControl
        Id="ServiceControl"
        Name="ServerKitAgent"
        Start="install"
        Stop="both"
        Remove="uninstall"
        Wait="yes" />
    </Component>

    <!-- Configuration -->
    <Component Id="ConfigComponent" Directory="AgentDataFolder" Guid="C3D4E5F6-A7B8-9012-CDEF-345678901234">
      <File Id="ConfigYaml" Source="config.yaml" KeyPath="yes" />
      <RemoveFile Id="RemoveConfig" Name="config.yaml" On="uninstall" />
      <RemoveFile Id="RemoveKey" Name="agent.key" On="uninstall" />
      <RemoveFolder Id="RemoveAgentDataFolder" On="uninstall" />
    </Component>
  </Fragment>

</Wix>
