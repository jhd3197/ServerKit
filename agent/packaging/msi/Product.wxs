<?xml version="1.0" encoding="UTF-8"?>
<!--
  ServerKit Agent - Windows MSI Installer
  Built with WiX Toolset v4

  Build instructions:
    1. Install WiX Toolset v4
    2. Run: wix build Product.wxs -o serverkit-agent.msi -define Version=1.0.0
-->
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

  <!-- Product definition -->
  <Package
    Name="ServerKit Agent"
    Manufacturer="ServerKit"
    Version="$(var.Version)"
    UpgradeCode="E8B7F3A2-4C5D-4E6F-8A9B-0C1D2E3F4A5B"
    Scope="perMachine">

    <SummaryInformation
      Description="ServerKit Agent - Remote server management agent"
      Keywords="ServerKit,Agent,Docker,Management"
      Manufacturer="ServerKit" />

    <!-- Upgrade handling -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      Schedule="afterInstallInitialize" />

    <!-- Media -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Feature -->
    <Feature Id="ProductFeature" Title="ServerKit Agent" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ConfigComponent" />
      <ComponentRef Id="TrayAutoStart" />
    </Feature>

  </Package>

  <!-- Directory Structure -->
  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="ServerKit Agent">
        <Directory Id="LogsFolder" Name="logs" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="ServerKitDataFolder" Name="ServerKit">
        <Directory Id="AgentDataFolder" Name="Agent" />
      </Directory>
    </StandardDirectory>
  </Fragment>

  <!-- Components -->
  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainExecutable" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
        <File Id="ServerKitAgentExe"
          Source="serverkit-agent.exe"
          KeyPath="yes" />
        <!-- Windows Service -->
        <ServiceInstall
          Id="ServiceInstall"
          Name="ServerKitAgent"
          DisplayName="ServerKit Agent"
          Description="ServerKit Agent - Remote server management service"
          Type="ownProcess"
          Start="auto"
          ErrorControl="normal"
          Arguments="start" />
        <ServiceControl
          Id="ServiceControl"
          Name="ServerKitAgent"
          Start="install"
          Stop="both"
          Remove="uninstall"
          Wait="yes" />
      </Component>
    </ComponentGroup>

    <!-- Configuration -->
    <Component Id="ConfigComponent" Directory="AgentDataFolder" Guid="C3D4E5F6-A7B8-9012-CDEF-345678901234">
      <File Id="ConfigYaml" Source="config.yaml" KeyPath="yes" />
      <RemoveFile Id="RemoveConfig" Name="config.yaml" On="uninstall" />
      <RemoveFile Id="RemoveKey" Name="agent.key" On="uninstall" />
      <RemoveFolder Id="RemoveAgentDataFolder" On="uninstall" />
    </Component>

    <!-- Auto-start tray on user login (uses main binary with tray command) -->
    <Component Id="TrayAutoStart" Directory="INSTALLFOLDER" Guid="E5F6A7B8-C9D0-1234-EF01-567890123456">
      <RegistryValue
        Root="HKCU"
        Key="Software\Microsoft\Windows\CurrentVersion\Run"
        Name="ServerKitTray"
        Type="string"
        Value="&quot;[INSTALLFOLDER]serverkit-agent.exe&quot; tray"
        KeyPath="yes" />
    </Component>
  </Fragment>

</Wix>
